# G2Own OAuth Integration Setup Guide

## Overview

This guide will help you set up OAuth 2.0 integration between your G2Own frontend and Invision Community backend. The integration provides seamless authentication, cart management, and e-commerce functionality.

## Prerequisites

1. **Invision Community 4.x** with Commerce application installed
2. **OAuth 2.0 Application** configured in Invision Community
3. **PHP 7.4+** for the OAuth callback handler
4. **SSL Certificate** (required for OAuth in production)

## Step 1: Configure OAuth in Invision Community

### 1.1 Create OAuth Application

1. Log into your Invision Community Admin CP
2. Go to **System** → **REST & OAuth** → **OAuth Clients**
3. Click **Create New**
4. Fill in the details:
   - **Name**: `G2Own Frontend`
   - **Client ID**: `g2own_frontend` (or your preferred ID)
   - **Redirect URIs**: 
     - `https://g2own.com/oauth/callback`
     - `https://g2own.com/oauth/callback.php`
   - **Scopes**: Select `read`, `profile`, `commerce` (and any others you need)
   - **Grant Types**: Select `Authorization Code`

### 1.2 Configure OAuth Settings

1. Go to **System** → **REST & OAuth** → **Settings**
2. Enable **OAuth 2.0**
3. Set **Access Token Lifetime** to `3600` seconds (1 hour)
4. Set **Refresh Token Lifetime** to `2592000` seconds (30 days)
5. Enable **Allow Refresh Tokens**

### 1.3 Note Important Details

Save these details for later configuration:
- **Client ID**: (e.g., `g2own_frontend`)
- **Client Secret**: (generated by Invision Community)
- **Community URL**: (e.g., `https://g2own.com/community`)

## Step 2: Configure Frontend Files

### 2.1 Update OAuth Configuration

Edit `assets/js/oauth-config.js`:

```javascript
window.G2OwnOAuthConfig = {
    oauth: {
        clientId: 'g2own_frontend', // Your actual client ID
        redirectURI: 'https://g2own.com/oauth/callback', // Your domain
        scope: 'read profile commerce cart orders'
    },
    
    community: {
        baseURL: 'https://g2own.com/community', // Your community URL
        storeURL: 'https://g2own.com/community/store',
        apiURL: 'https://g2own.com/community/api'
    },
    
    frontend: {
        baseURL: 'https://g2own.com', // Your frontend domain
        callbackURL: 'https://g2own.com/oauth/callback'
    }
    
    // ... rest of configuration
};
```

### 2.2 Configure OAuth Callback Handler

Edit `oauth/callback.php`:

```php
$config = [
    'community_url' => 'https://g2own.com/community', // Your community URL
    'client_id' => 'g2own_frontend', // Your client ID
    'client_secret' => 'your_actual_client_secret', // From Invision Community
    'redirect_uri' => 'https://g2own.com/oauth/callback',
    'frontend_url' => 'https://g2own.com' // Your frontend URL
];
```

## Step 3: File Structure Setup

Ensure your file structure looks like this:

```
g2own_home/
├── index.html
├── oauth/
│   └── callback.php
├── assets/
│   ├── css/
│   └── js/
│       ├── oauth-config.js
│       ├── oauth-integration.js
│       ├── cart-oauth-integration.js
│       ├── product-display-oauth.js
│       └── oauth-manager.js
└── api/ (optional)
    └── oauth/
        ├── session-exchange.php
        ├── refresh.php
        └── logout.php
```

## Step 4: Server Configuration

### 4.1 Apache Configuration (.htaccess)

Create or update `.htaccess` in your root directory:

```apache
# OAuth Callback Rewrite
RewriteEngine On
RewriteRule ^oauth/callback/?$ oauth/callback.php [L,QSA]

# Enable CORS for OAuth
<IfModule mod_headers.c>
    Header set Access-Control-Allow-Origin "https://g2own.com"
    Header set Access-Control-Allow-Credentials true
    Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
</IfModule>

# Security Headers
Header always set X-Frame-Options SAMEORIGIN
Header always set X-Content-Type-Options nosniff
Header always set Referrer-Policy "strict-origin-when-cross-origin"
```

### 4.2 Nginx Configuration (Alternative)

If using Nginx, add to your server block:

```nginx
location /oauth/callback {
    try_files $uri $uri/ /oauth/callback.php?$query_string;
}

# CORS headers
add_header 'Access-Control-Allow-Origin' 'https://g2own.com' always;
add_header 'Access-Control-Allow-Credentials' 'true' always;
add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;
```

## Step 5: Database Setup (Optional)

If you want to store additional session data, create these tables:

```sql
CREATE TABLE oauth_sessions (
    id VARCHAR(255) PRIMARY KEY,
    user_id INT NOT NULL,
    access_token TEXT NOT NULL,
    refresh_token TEXT,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE oauth_state (
    state VARCHAR(255) PRIMARY KEY,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_created (created_at)
);
```

## Step 6: Testing the Integration

### 6.1 Test OAuth Flow

1. Open your website
2. Click any "Sign In" button
3. You should be redirected to Invision Community login
4. After login, you should be redirected back to your site
5. Check browser console for OAuth success messages

### 6.2 Test Cart Integration

1. Ensure you're logged in via OAuth
2. Try adding items to cart
3. Items should sync with Invision Community store
4. Check that cart persists across page reloads

### 6.3 Debug Common Issues

#### OAuth Redirect Mismatch
- Error: `redirect_uri_mismatch`
- Solution: Ensure redirect URI in config matches exactly what's set in Invision Community

#### CORS Errors
- Error: `CORS policy: No 'Access-Control-Allow-Origin' header`
- Solution: Check server CORS configuration and ensure community allows your domain

#### Token Errors
- Error: `invalid_client` or `invalid_grant`
- Solution: Verify client ID and secret are correct

## Step 7: Production Deployment

### 7.1 Security Checklist

- [ ] SSL certificate installed and configured
- [ ] Client secret is secure and not exposed in frontend code
- [ ] CORS headers properly configured
- [ ] Rate limiting implemented for OAuth endpoints
- [ ] Session security configured (secure cookies, etc.)

### 7.2 Performance Optimization

- [ ] Enable gzip compression for JavaScript files
- [ ] Configure caching headers for static assets
- [ ] Implement CDN for better global performance
- [ ] Monitor OAuth API rate limits

### 7.3 Monitoring

Set up monitoring for:
- OAuth success/failure rates
- API response times
- Token refresh frequency
- Cart synchronization errors

## Step 8: Customization

### 8.1 Custom OAuth Scopes

To add custom scopes, modify in Invision Community:
1. Go to **System** → **REST & OAuth** → **Scopes**
2. Create custom scopes as needed
3. Update `oauth-config.js` with new scopes

### 8.2 Custom UI Elements

The integration supports customization through:
- CSS classes for styling OAuth buttons
- Event listeners for custom OAuth flow handling
- Configuration options in `oauth-config.js`

### 8.3 Additional Features

Consider implementing:
- Social login integration
- Multi-factor authentication
- Custom user profile management
- Advanced cart features

## Troubleshooting

### Common Error Messages

| Error | Cause | Solution |
|-------|-------|----------|
| `invalid_client` | Wrong client ID/secret | Check OAuth app configuration |
| `invalid_scope` | Requesting unavailable scope | Verify enabled scopes in community |
| `access_denied` | User denied OAuth permission | Normal user behavior, handle gracefully |
| `invalid_grant` | Expired authorization code | Implement proper error handling |

### Debug Mode

Enable debug mode by setting in `oauth-config.js`:

```javascript
debug: {
    enableLogging: true,
    logLevel: 'debug',
    enableConsoleOutput: true,
    enableNetworkLogging: true
}
```

## Support

For issues with this integration:

1. Check the browser console for error messages
2. Verify all configuration settings
3. Test OAuth flow manually using tools like Postman
4. Check Invision Community logs for OAuth-related errors

## Security Considerations

1. **Never expose client secret** in frontend JavaScript
2. **Use HTTPS** for all OAuth communications
3. **Validate state parameter** to prevent CSRF attacks
4. **Implement proper session timeout** handling
5. **Regular security audits** of OAuth implementation

## Updates and Maintenance

1. **Monitor Invision Community updates** that might affect OAuth
2. **Keep OAuth libraries updated** to latest versions
3. **Regular testing** of the complete OAuth flow
4. **Backup OAuth configuration** before making changes

---

This completes the OAuth integration setup. The system provides seamless authentication between your frontend and Invision Community, with full e-commerce capabilities including cart management and user authentication.
